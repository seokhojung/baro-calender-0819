# üîå **8b. GraphQL API Integration**

## üìã Î¨∏ÏÑú Ï†ïÎ≥¥
- **Î¨∏ÏÑú Î≤ÑÏ†Ñ**: 1.0
- **ÏûëÏÑ±Ïùº**: 2025-08-19
- **ÏûëÏÑ±Ïûê**: Architect Winston
- **ÌîÑÎ°úÏ†ùÌä∏Î™Ö**: Î∞îÎ°úÏ∫òÎ¶∞Îçî (Baro Calendar)
- **ÏÉÅÌÉú**: Active
- **Ïπ¥ÌÖåÍ≥†Î¶¨**: ÌîÑÎ°†Ìä∏ÏóîÎìú ÏïÑÌÇ§ÌÖçÏ≤ò - GraphQL API ÌÜµÌï©

---

## üéØ **Í∞úÏöî**

Ïù¥ Î¨∏ÏÑúÎäî Î∞îÎ°úÏ∫òÎ¶∞Îçî ÌîÑÎ°úÏ†ùÌä∏Ïùò **GraphQL API ÏÑ§Í≥Ñ Î∞è ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÌÜµÌï©** ÏïÑÌÇ§ÌÖçÏ≤òÎ•º Ï†ïÏùòÌï©ÎãàÎã§. ÌÉÄÏûÖ ÏïàÏ†ÑÏÑ±, Ìö®Ïú®Ï†ÅÏù∏ Îç∞Ïù¥ÌÑ∞ ÌéòÏπ≠, ÏµúÏ†ÅÌôîÎêú Ï∫êÏã± Ï†ÑÎûµÏùÑ ÌÜµÌï¥ Í≥†ÏÑ±Îä• API ÌÜµÌï©ÏùÑ Íµ¨ÌòÑÌï©ÎãàÎã§.

---

## üìä **GraphQL Ïä§ÌÇ§Îßà Ï†ïÏùò**

### **Í∏∞Î≥∏ ÌÉÄÏûÖ Ï†ïÏùò**
```typescript
// src/lib/graphql/schema.ts
import { gql } from '@apollo/client'

// ÌÉÄÏûÖ Ï†ïÏùò
export const typeDefs = gql`
  scalar DateTime
  scalar JSON
  
  type User {
    id: ID!
    email: String!
    name: String!
    avatar: String
    timezone: String!
    language: String!
    createdAt: DateTime!
    updatedAt: DateTime!
    projects: [Project!]!
    events: [Event!]!
  }
  
  type Project {
    id: ID!
    name: String!
    description: String
    color: String!
    isPublic: Boolean!
    createdAt: DateTime!
    updatedAt: DateTime!
    owner: User!
    members: [ProjectMember!]!
    events: [Event!]!
  }
  
  type ProjectMember {
    id: ID!
    project: Project!
    user: User!
    role: ProjectRole!
    joinedAt: DateTime!
  }
  
  enum ProjectRole {
    OWNER
    ADMIN
    MEMBER
    VIEWER
  }
  
  type Event {
    id: ID!
    title: String!
    description: String
    startDate: DateTime!
    endDate: DateTime!
    allDay: Boolean!
    location: String
    project: Project
    attendees: [EventAttendee!]!
    recurring: RecurringRule
    createdAt: DateTime!
    updatedAt: DateTime!
  }
  
  type EventAttendee {
    id: ID!
    event: Event!
    user: User!
    status: AttendanceStatus!
    responseAt: DateTime
  }
  
  enum AttendanceStatus {
    PENDING
    ACCEPTED
    DECLINED
    TENTATIVE
  }
  
  type RecurringRule {
    id: ID!
    frequency: RecurringFrequency!
    interval: Int!
    endDate: DateTime
    count: Int
    daysOfWeek: [Int!]
    daysOfMonth: [Int!]
    monthsOfYear: [Int!]
  }
  
  enum RecurringFrequency {
    DAILY
    WEEKLY
    MONTHLY
    YEARLY
  }
`
```

### **Query/Mutation/Subscription Ï†ïÏùò**
```typescript
export const operations = gql`
  type Query {
    # ÏÇ¨Ïö©Ïûê Í¥ÄÎ†®
    me: User
    user(id: ID!): User
    
    # ÌîÑÎ°úÏ†ùÌä∏ Í¥ÄÎ†®
    projects: [Project!]!
    project(id: ID!): Project
    myProjects: [Project!]!
    
    # Ïù¥Î≤§Ìä∏ Í¥ÄÎ†®
    events(
      startDate: DateTime!
      endDate: DateTime!
      projectIds: [ID!]
      userIds: [ID!]
    ): [Event!]!
    event(id: ID!): Event
    
    # Í≤ÄÏÉâ
    searchEvents(query: String!): [Event!]!
    searchProjects(query: String!): [Project!]!
  }
  
  type Mutation {
    # ÏÇ¨Ïö©Ïûê Í¥ÄÎ†®
    updateProfile(input: UpdateProfileInput!): User!
    
    # ÌîÑÎ°úÏ†ùÌä∏ Í¥ÄÎ†®
    createProject(input: CreateProjectInput!): Project!
    updateProject(id: ID!, input: UpdateProjectInput!): Project!
    deleteProject(id: ID!): Boolean!
    addProjectMember(projectId: ID!, input: AddMemberInput!): ProjectMember!
    removeProjectMember(projectId: ID!, userId: ID!): Boolean!
    
    # Ïù¥Î≤§Ìä∏ Í¥ÄÎ†®
    createEvent(input: CreateEventInput!): Event!
    updateEvent(id: ID!, input: UpdateEventInput!): Event!
    deleteEvent(id: ID!): Boolean!
    respondToEvent(eventId: ID!, status: AttendanceStatus!): EventAttendee!
  }
  
  type Subscription {
    # Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
    eventUpdated(projectId: ID!): Event!
    projectUpdated: Project!
    userJoinedProject(projectId: ID!): ProjectMember!
  }
`
```

### **ÏûÖÎ†• ÌÉÄÏûÖ Ï†ïÏùò**
```typescript
export const inputTypes = gql`
  # ÏûÖÎ†• ÌÉÄÏûÖÎì§
  input UpdateProfileInput {
    name: String
    timezone: String
    language: String
    avatar: String
  }
  
  input CreateProjectInput {
    name: String!
    description: String
    color: String!
    isPublic: Boolean!
  }
  
  input UpdateProjectInput {
    name: String
    description: String
    color: String
    isPublic: Boolean
  }
  
  input AddMemberInput {
    userId: ID!
    role: ProjectRole!
  }
  
  input CreateEventInput {
    title: String!
    description: String
    startDate: DateTime!
    endDate: DateTime!
    allDay: Boolean!
    location: String
    projectId: ID
    attendeeIds: [ID!]
    recurring: RecurringRuleInput
  }
  
  input UpdateEventInput {
    title: String
    description: String
    startDate: DateTime
    endDate: DateTime
    allDay: Boolean
    location: String
    projectId: ID
    attendeeIds: [ID!]
    recurring: RecurringRuleInput
  }
  
  input RecurringRuleInput {
    frequency: RecurringFrequency!
    interval: Int!
    endDate: DateTime
    count: Int
    daysOfWeek: [Int!]
    daysOfMonth: [Int!]
    monthsOfYear: [Int!]
  }
`
```

---

## üîß **GraphQL ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÑ§Ï†ï**

### **Apollo Client Íµ¨ÏÑ±**
```typescript
// src/lib/graphql/client.ts
import { ApolloClient, InMemoryCache, createHttpLink, from } from '@apollo/client'
import { setContext } from '@apollo/client/link/context'
import { onError } from '@apollo/client/link/error'
import { RetryLink } from '@apollo/client/link/retry'
import { BatchHttpLink } from '@apollo/client/link/batch-http'

// HTTP ÎßÅÌÅ¨ ÏÑ§Ï†ï
const httpLink = createHttpLink({
  uri: process.env.NEXT_PUBLIC_GRAPHQL_ENDPOINT || 'http://localhost:4000/graphql',
})

// Î∞∞Ïπò HTTP ÎßÅÌÅ¨ (Ïó¨Îü¨ ÏöîÏ≤≠ÏùÑ ÌïòÎÇòÎ°ú Î¨∂Ïñ¥ÏÑú Ï†ÑÏÜ°)
const batchHttpLink = new BatchHttpLink({
  uri: process.env.NEXT_PUBLIC_GRAPHQL_ENDPOINT || 'http://localhost:4000/graphql',
  batchMax: 5, // ÏµúÎåÄ 5Í∞ú ÏöîÏ≤≠ÏùÑ Î¨∂Ïùå
  batchInterval: 20, // 20ms ÎåÄÍ∏∞
})

// Ïù∏Ï¶ù Ìó§Îçî Ï∂îÍ∞Ä
const authLink = setContext((_, { headers }) => {
  const token = localStorage.getItem('auth-token')
  
  return {
    headers: {
      ...headers,
      authorization: token ? `Bearer ${token}` : '',
    },
  }
})

// ÏóêÎü¨ Ï≤òÎ¶¨
const errorLink = onError(({ graphQLErrors, networkError, operation, forward }) => {
  if (graphQLErrors) {
    graphQLErrors.forEach(({ message, locations, path }) => {
      console.error(
        `GraphQL error: Message: ${message}, Location: ${locations}, Path: ${path}`
      )
      
      // Ïù∏Ï¶ù ÏóêÎü¨ Ï≤òÎ¶¨
      if (message.includes('Unauthorized') || message.includes('Forbidden')) {
        // ÌÜ†ÌÅ∞ Í∞±Ïã† ÎòêÎäî Î°úÍ∑∏ÏïÑÏõÉ
        localStorage.removeItem('auth-token')
        window.location.href = '/login'
      }
    })
  }
  
  if (networkError) {
    console.error('Network error:', networkError)
    
    // ÎÑ§Ìä∏ÏõåÌÅ¨ ÏóêÎü¨ Ïãú Ïû¨ÏãúÎèÑ (Îü∞ÌÉÄÏûÑ ÌÉÄÏûÖ Í∞ÄÎìú Ï†ÅÏö©)
    if ('statusCode' in networkError && networkError.statusCode === 500) {
      return forward(operation)
    }
  }
})

// Ïû¨ÏãúÎèÑ ÎßÅÌÅ¨
const retryLink = new RetryLink({
  delay: {
    initial: 300,
    max: 3000,
    jitter: true,
  },
  attempts: {
    max: 3,
    retryIf: (error, _operation) => {
      // ÌäπÏ†ï ÏóêÎü¨Îßå Ïû¨ÏãúÎèÑ (Îü∞ÌÉÄÏûÑ ÌÉÄÏûÖ Í∞ÄÎìú Ï†ÅÏö©)
      return !!error && 'statusCode' in error && error.statusCode >= 500
    },
  },
})
```

### **Ï∫êÏãú ÏÑ§Ï†ï**
```typescript
// Ï∫êÏãú ÏÑ§Ï†ï
const cache = new InMemoryCache({
  typePolicies: {
    Query: {
      fields: {
        events: {
          keyArgs: ['startDate', 'endDate', 'projectIds', 'userIds'],
          merge(existing = [], incoming) {
            return [...existing, ...incoming]
          },
        },
        projects: {
          keyArgs: false,
          merge(existing = [], incoming) {
            return [...existing, ...incoming]
          },
        },
      },
    },
    Event: {
      keyFields: ['id'],
      fields: {
        attendees: {
          merge(existing = [], incoming) {
            return incoming
          },
        },
      },
    },
    Project: {
      keyFields: ['id'],
      fields: {
        members: {
          merge(existing = [], incoming) {
            return incoming
          },
        },
        events: {
          merge(existing = [], incoming) {
            return incoming
          },
        },
      },
    },
  },
})

// Apollo ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÉùÏÑ±
export const client = new ApolloClient({
  link: from([
    errorLink,
    retryLink,
    authLink,
    batchHttpLink,
  ]),
  cache,
  defaultOptions: {
    watchQuery: {
      errorPolicy: 'all',
      fetchPolicy: 'cache-and-network',
    },
    query: {
      errorPolicy: 'all',
      fetchPolicy: 'cache-first',
    },
    mutate: {
      errorPolicy: 'all',
    },
  },
  connectToDevTools: process.env.NODE_ENV === 'development',
})
```

---

## üé£ **GraphQL Hooks & Queries**

### **ÏÇ¨Ïö©Ïûê Í¥ÄÎ†® Hooks**
```typescript
// src/hooks/graphql/useUser.ts
import { useQuery, useMutation } from '@apollo/client'
import { gql } from '@apollo/client'

export const GET_ME = gql`
  query GetMe {
    me {
      id
      email
      name
      avatar
      timezone
      language
      projects {
        id
        name
        color
      }
    }
  }
`

export const UPDATE_PROFILE = gql`
  mutation UpdateProfile($input: UpdateProfileInput!) {
    updateProfile(input: $input) {
      id
      name
      timezone
      language
      avatar
    }
  }
`

export const useMe = () => {
  return useQuery(GET_ME)
}

export const useUpdateProfile = () => {
  return useMutation(UPDATE_PROFILE, {
    refetchQueries: [{ query: GET_ME }],
  })
}
```

### **Ïù¥Î≤§Ìä∏ Í¥ÄÎ†® Hooks**
```typescript
// src/hooks/graphql/useEvents.ts
export const GET_EVENTS = gql`
  query GetEvents(
    $startDate: DateTime!
    $endDate: DateTime!
    $projectIds: [ID!]
    $userIds: [ID!]
  ) {
    events(
      startDate: $startDate
      endDate: $endDate
      projectIds: $projectIds
      userIds: $userIds
    ) {
      id
      title
      description
      startDate
      endDate
      allDay
      location
      project {
        id
        name
        color
      }
      attendees {
        user {
          id
          name
          avatar
        }
        status
      }
      recurring {
        frequency
        interval
      }
    }
  }
`

export const CREATE_EVENT = gql`
  mutation CreateEvent($input: CreateEventInput!) {
    createEvent(input: $input) {
      id
      title
      startDate
      endDate
    }
  }
`

export const useEvents = (variables: any) => {
  return useQuery(GET_EVENTS, {
    variables,
    fetchPolicy: 'cache-and-network',
  })
}

export const useCreateEvent = () => {
  return useMutation(CREATE_EVENT, {
    update(cache, { data: { createEvent } }) {
      // Ï∫êÏãú ÏóÖÎç∞Ïù¥Ìä∏
      const existing = cache.readQuery({
        query: GET_EVENTS,
        variables: {
          startDate: new Date().toISOString(),
          endDate: new Date().toISOString(),
        },
      })
      
      if (existing) {
        cache.writeQuery({
          query: GET_EVENTS,
          variables: {
            startDate: new Date().toISOString(),
            endDate: new Date().toISOString(),
          },
          data: {
            events: [...existing.events, createEvent],
          },
        })
      }
    },
  })
}
```

### **ÌîÑÎ°úÏ†ùÌä∏ Í¥ÄÎ†® Hooks**
```typescript
// src/hooks/graphql/useProjects.ts
export const GET_PROJECTS = gql`
  query GetProjects {
    myProjects {
      id
      name
      description
      color
      isPublic
      owner {
        id
        name
      }
      members {
        user {
          id
          name
          avatar
        }
        role
      }
    }
  }
`

export const CREATE_PROJECT = gql`
  mutation CreateProject($input: CreateProjectInput!) {
    createProject(input: $input) {
      id
      name
      color
    }
  }
`

export const useProjects = () => {
  return useQuery(GET_PROJECTS)
}

export const useCreateProject = () => {
  return useMutation(CREATE_PROJECT, {
    refetchQueries: [{ query: GET_PROJECTS }],
  })
}
```

---

## üöÄ **ÏµúÏ†ÅÌôî Ï†ÑÎûµ**

### **ÏøºÎ¶¨ ÏµúÏ†ÅÌôî**
```typescript
// Fragment Ïû¨ÏÇ¨Ïö©
export const EVENT_FRAGMENT = gql`
  fragment EventDetails on Event {
    id
    title
    description
    startDate
    endDate
    allDay
    location
  }
`

// Fragment ÏÇ¨Ïö©
export const GET_EVENT_WITH_DETAILS = gql`
  ${EVENT_FRAGMENT}
  query GetEvent($id: ID!) {
    event(id: $id) {
      ...EventDetails
      project {
        id
        name
        color
      }
      attendees {
        user {
          id
          name
        }
        status
      }
    }
  }
`
```

### **Persisted Queries**
```typescript
// APQ (Automatic Persisted Queries) ÏÑ§Ï†ï
import { createPersistedQueryLink } from '@apollo/client/link/persisted-queries'
import { sha256 } from 'crypto-hash'

const persistedQueriesLink = createPersistedQueryLink({
  sha256,
  useGETForHashedQueries: true,
})
```

---

## üìã **ÏöîÏïΩ**

Ïù¥ Î¨∏ÏÑúÎäî Î∞îÎ°úÏ∫òÎ¶∞ÎçîÏùò GraphQL API ÌÜµÌï©ÏùÑ Ï†ïÏùòÌï©ÎãàÎã§:

### **üîß API ÏÑ§Í≥Ñ**
- **ÌÉÄÏûÖ ÏïàÏ†ÑÏÑ±**: TypeScriptÏôÄ GraphQL ÏΩîÎìú ÏÉùÏÑ±
- **Ïä§ÌÇ§Îßà Ï†ïÏùò**: Î™ÖÌôïÌïú ÌÉÄÏûÖÍ≥º Í¥ÄÍ≥Ñ Ï†ïÏùò
- **Ìö®Ïú®Ï†Å ÏøºÎ¶¨**: FragmentÏôÄ Î∞∞Ïπò Ï≤òÎ¶¨

### **‚ö° ÏµúÏ†ÅÌôî**
- **Ï∫êÏã± Ï†ÑÎûµ**: InMemoryCacheÏôÄ ÌÉÄÏûÖ Ï†ïÏ±Ö
- **Î∞∞Ïπò ÏöîÏ≤≠**: Ïó¨Îü¨ ÏøºÎ¶¨Î•º ÌïòÎÇòÎ°ú Î¨∂Ïùå
- **ÏóêÎü¨ Ï≤òÎ¶¨**: Ïû¨ÏãúÎèÑ Î°úÏßÅÍ≥º ÏóêÎü¨ Î≥µÍµ¨

### **üé£ Í∞úÎ∞úÏûê Í≤ΩÌóò**
- **Custom Hooks**: Ïû¨ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏøºÎ¶¨/ÎÆ§ÌÖåÏù¥ÏÖò
- **ÏûêÎèô ÏôÑÏÑ±**: TypeScript ÌÉÄÏûÖ Ï∂îÎ°†
- **Í∞úÎ∞ú ÎèÑÍµ¨**: Apollo DevTools ÏßÄÏõê