# Story 1.6: 공유(권한 기반) 시스템

## Status
Draft

## Story
**As a** 프로젝트 소유자,
**I want** 팀원을 초대하고 권한을 관리하며 읽기전용 링크를 생성할 수 있고,
**so that** 프로젝트를 안전하게 공유하고 협업할 수 있다.

## Acceptance Criteria
1. 멤버 초대 시스템 구현 (이메일 기반, 역할별 권한)
2. 권한 기반 접근 제어 구현 (Owner/Editor/Commenter/Viewer)
3. 읽기전용 공유 링크 생성 및 관리 기능 구현
4. 공유 링크 보안 정책 구현 (토큰 해시, 만료, 접근 로그)
5. 멤버 권한 변경 및 제거 기능 구현
6. 공유 링크 접근 통계 및 모니터링 구현
7. 레이트 리미팅 및 보안 강화 구현
8. 단위 테스트 및 통합 테스트 구현

## Tasks / Subtasks
- [ ] 멤버 초대 시스템 구현 (AC: 1)
  - [ ] 이메일 초대 발송 API (`POST /v1/projects/:id/invites`)
  - [ ] 초대 토큰 생성 및 검증
  - [ ] 초대 상태 관리 (pending, accepted, expired)
  - [ ] 초대 수락/거절 처리
- [ ] 권한 기반 접근 제어 구현 (AC: 2)
  - [ ] ACL 미들웨어 구현 (토큰→유저→멤버 역할 확인)
  - [ ] 엔드포인트 가드 공통화
  - [ ] 역할별 권한 매트릭스 적용
  - [ ] 권한 검증 로직 구현
- [ ] 읽기전용 공유 링크 구현 (AC: 3)
  - [ ] 공유 링크 생성 API (`POST /v1/projects/:id/share-links`)
  - [ ] 토큰 해시 생성 및 저장 (원문 미저장)
  - [ ] 링크 만료 설정 (7일/24시간/30일)
  - [ ] 링크 폐기 및 일괄 폐기 기능
- [ ] 공유 링크 보안 정책 구현 (AC: 4)
  - [ ] 128비트 랜덤 토큰 생성 (URL-safe)
  - [ ] 토큰 해시 저장 (DB에 원문 미저장)
  - [ ] 만료 시간 자동 처리
  - [ ] 접근 로그 적재 (30일 보관)
- [ ] 멤버 권한 관리 구현 (AC: 5)
  - [ ] 멤버 권한 변경 API (`PATCH /v1/projects/:id/members/:memberId`)
  - [ ] 멤버 제거 API (`DELETE /v1/projects/:id/members/:memberId`)
  - [ ] 권한 변경 감사 로그
  - [ ] 소유자 변경 기능 (Owner만 가능)
- [ ] 공유 링크 모니터링 구현 (AC: 6)
  - [ ] 접근 통계 API (`GET /v1/projects/:id/share-links/:id/stats`)
  - [ ] IP 대역별 접근 로그 (시간, IP 대역 /24)
  - [ ] 접근 패턴 분석
  - [ ] 이상 접근 탐지
- [ ] 보안 강화 구현 (AC: 7)
  - [ ] 레이트 리미팅 (토큰·IP 별 60 rpm)
  - [ ] 도메인 제한 옵션 (`*.corp.example` 허용 리스트)
  - [ ] CSRF 보호 (쿠키 사용 시)
  - [ ] CORS 화이트리스트 설정
- [ ] 테스트 구현 (AC: 8)
  - [ ] 단위 테스트 작성 (권한 검증, 토큰 생성)
  - [ ] 통합 테스트 작성 (API 엔드포인트, ACL)
  - [ ] 보안 테스트 작성 (권한 우회, 토큰 탈취)
  - [ ] 성능 테스트 작성 (레이트 리미팅)

## Dev Notes

### Previous Story Insights
Story 1.1의 프로젝트/멤버 시스템과 Story 1.2의 인증 시스템을 확장하여 권한 기반 접근 제어와 공유 기능을 구현합니다. 기존 멤버 테이블에 역할 정보를 추가하고, 새로운 공유 링크 시스템을 구축합니다.

### Data Models
- **멤버 테이블**: `members(id, tenant_id, project_id, user_id, role, invited_at, accepted_at, created_at, updated_at)` [Source: architecture.md#3.1]
- **공유 링크 테이블**: `share_links(id, tenant_id, project_id, token_hash, expires_at, created_by, created_at, revoked_at)` [Source: architecture.md#3.1]
- **접근 로그 테이블**: `share_link_access_logs(id, share_link_id, ip_address, user_agent, accessed_at, ip_range)` [Source: architecture.md#3.1]
- **초대 테이블**: `project_invites(id, tenant_id, project_id, email, role, token_hash, expires_at, status, created_at)` [Source: architecture.md#3.1]

### API Specifications
- **멤버 초대**: `POST /v1/projects/:id/invites` [Source: architecture.md#5]
- **멤버 권한 변경**: `PATCH /v1/projects/:id/members/:memberId` [Source: architecture.md#5]
- **멤버 제거**: `DELETE /v1/projects/:id/members/:memberId` [Source: architecture.md#5]
- **공유 링크 생성**: `POST /v1/projects/:id/share-links` [Source: architecture.md#5]
- **공유 링크 폐기**: `DELETE /v1/projects/:id/share-links/:linkId` [Source: architecture.md#5]
- **접근 통계**: `GET /v1/projects/:id/share-links/:linkId/stats` [Source: architecture.md#5]

#### API 요청/응답 예시
**멤버 초대**
```json
POST /v1/projects/proj_123/invites
{
  "email": "designer@example.com",
  "role": "Editor",
  "message": "프로젝트에 참여해주세요!"
}

Response: 201 Created
{
  "id": "invite_789",
  "email": "designer@example.com",
  "role": "Editor",
  "status": "pending",
  "expires_at": "2025-08-21T10:00:00Z",
  "invite_url": "https://app.example.com/invite/token_abc123"
}
```

**공유 링크 생성**
```json
POST /v1/projects/proj_123/share-links
{
  "expires_in_days": 7,
  "allow_domain_restriction": false
}

Response: 201 Created
{
  "id": "share_456",
  "share_url": "https://app.example.com/share/abc123def456",
  "expires_at": "2025-08-21T10:00:00Z",
  "created_at": "2025-08-14T10:00:00Z"
}
```

**권한 기반 접근 제어 예시**
```json
GET /v1/projects/proj_123/events
Authorization: Bearer <jwt_token>

Response: 200 OK (Editor 권한으로 접근)
{
  "events": [...],
  "permissions": {
    "can_edit": true,
    "can_comment": true,
    "can_invite": false,
    "can_share": false
  }
}
```

### Component Specifications
- **권한 모델**: Owner/Editor/Commenter/Viewer 4단계 [Source: prd/06-permissions-acl.md]
- **공유 링크 보안**: 128비트 랜덤 토큰, 해시 저장, 만료 관리 [Source: prd/07-share-link-security-and-ops.md]
- **접근 로그**: 30일 보관, IP 대역 축약 (/24) [Source: prd/07-share-link-security-and-ops.md]
- **레이트 리미팅**: 토큰·IP 별 60 rpm [Source: prd/07-share-link-security-and-ops.md]

### File Locations
- **API 라우터**: `src/api/v1/projects.js`, `src/api/v1/share-links.js`
- **서비스 레이어**: `src/services/inviteService.js`, `src/services/shareLinkService.js`, `src/services/permissionService.js`
- **미들웨어**: `src/middleware/acl.js`, `src/middleware/rateLimit.js`
- **유틸리티**: `src/utils/tokenGenerator.js`, `src/utils/permissionChecker.js`
- **마이그레이션**: `src/database/migrations/005_add_sharing_permissions.js`
- **테스트**: `tests/unit/sharing/`, `tests/integration/sharing/`

### Testing Requirements
- **테스트 프레임워크**: 단위 테스트 및 통합 테스트 [Source: architecture.md#9]
- **테스트 위치**: `tests/unit/sharing/`, `tests/integration/sharing/`
- **테스트 범위**: 권한 검증, 토큰 생성, ACL 미들웨어, 보안 테스트
- **특별 고려사항**: 권한 우회 테스트, 토큰 탈취 테스트, 레이트 리미팅 테스트

### Technical Constraints
- **데이터베이스**: PostgreSQL 사용 [Source: architecture.md#2]
- **보안**: HTTPS/HSTS, CSP, XSS/SQLi 무해화 [Source: architecture.md#6]
- **토큰 관리**: 원문 미저장, 해시만 저장 [Source: prd/07-share-link-security-and-ops.md]
- **멀티테넌시**: 모든 테이블에 `tenant_id` 포함 [Source: architecture.md#3.1]

#### 보안 및 성능 요구사항
- **토큰 보안**: 128비트 이상 랜덤, URL-safe [Source: prd/07-share-link-security-and-ops.md]
- **접근 로그**: 30일 보관, IP 대역 축약 [Source: prd/07-share-link-security-and-ops.md]
- **레이트 리미팅**: 60 rpm, 429 응답 (Retry-After 포함) [Source: prd/07-share-link-security-and-ops.md]
- **도메인 제한**: 옵션으로 `*.corp.example` 허용 리스트 [Source: prd/07-share-link-security-and-ops.md]

### Project Structure Notes
공유(권한 기반) 시스템은 Story 1.1의 프로젝트/멤버 시스템을 확장합니다. 기존 멤버 테이블에 역할 정보를 추가하고, 새로운 공유 링크와 초대 시스템을 구축합니다.

#### 공유 시스템 처리 플로우
```
멤버 초대 → 이메일 발송 → 초대 수락 → 권한 부여 → 공유 링크 생성 → 접근 제어 → 로그 기록
```

#### 엣지 케이스 및 예외 처리
- **중복 초대**: 같은 이메일로 재초대 시 기존 초대 상태 확인 및 업데이트
- **권한 상승**: Editor가 Owner 권한으로 변경 시도 시 403 Forbidden 반환
- **토큰 만료**: 만료된 공유 링크 접근 시 410 Gone 반환
- **권한 부족**: 권한이 없는 작업 시도 시 403 Forbidden 반환
- **초대 만료**: 만료된 초대 링크 접근 시 410 Gone 반환
- **레이트 리미팅 초과**: 초과 요청 시 429 Too Many Requests 반환
- **IP 제한**: 허용되지 않은 도메인 접근 시 403 Forbidden 반환
- **토큰 충돌**: 토큰 해시 충돌 시 재생성 및 재시도

## Testing
- **테스트 파일 위치**: `tests/unit/sharing/`, `tests/integration/sharing/`
- **테스트 표준**: 단위 테스트, 통합 테스트, 보안 테스트, 성능 테스트 구현
- **테스트 프레임워크**: Jest 사용
- **특정 테스트 요구사항**: 권한 우회 테스트, 토큰 탈취 테스트, ACL 미들웨어 테스트, 레이트 리미팅 테스트

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-14 | 1.0 | 초기 스토리 생성 | Scrum Master |

## Dev Agent Record
*이 섹션은 개발 에이전트가 구현 중에 작성합니다.*

### Agent Model Used
*구현 시 사용된 AI 에이전트 모델과 버전을 기록합니다.*

### Debug Log References
*개발 중 생성된 디버그 로그나 추적을 기록합니다.*

### Completion Notes List
*작업 완료 및 발생한 이슈에 대한 노트를 기록합니다.*

### File List
*스토리 구현 중 생성, 수정 또는 영향받은 모든 파일을 나열합니다.*

## QA Results
*QA 에이전트의 완성된 스토리 구현 검토 결과입니다.*
