# Story 1.7: 인앱 기본 알림 시스템

## Status
Draft

## Story
**As a** 사용자,
**I want** 일정 시작 전 알림을 받을 수 있고,
**so that** 중요한 일정을 놓치지 않고 준비할 수 있다.

## Acceptance Criteria
1. 일정 시작 전 알림 설정 기능 구현 (기본 10분, 사용자 설정 가능)
2. 인앱 알림 생성 및 표시 기능 구현
3. 알림 상태 관리 시스템 구현 (읽음/안읽음, 삭제)
4. 알림 우선순위 및 분류 시스템 구현
5. 알림 배치 처리 및 성능 최적화 구현
6. 알림 설정 개인화 기능 구현
7. 알림 히스토리 및 통계 기능 구현
8. 단위 테스트 및 통합 테스트 구현

## Tasks / Subtasks
- [ ] 알림 데이터 모델 설계 (AC: 1, 2, 3)
  - [ ] 알림 테이블 스키마 생성 (`notifications` 테이블)
  - [ ] 알림 설정 테이블 스키마 생성 (`notification_settings` 테이블)
  - [ ] 알림 상태 관리 필드 설계
  - [ ] 마이그레이션 스크립트 작성
- [ ] 알림 생성 엔진 구현 (AC: 1, 2)
  - [ ] 일정 시작 시간 기반 알림 스케줄링
  - [ ] 알림 생성 워커 시스템 구현
  - [ ] 알림 내용 템플릿 시스템
  - [ ] 다국어 지원 (한국어/영어)
- [ ] 알림 표시 및 상태 관리 구현 (AC: 2, 3)
  - [ ] 인앱 알림 컴포넌트 구현
  - [ ] 알림 목록 및 상세 보기
  - [ ] 읽음/안읽음 상태 토글
  - [ ] 알림 삭제 및 일괄 삭제
- [ ] 알림 우선순위 및 분류 구현 (AC: 4)
  - [ ] 알림 유형별 분류 (일정, 시스템, 보안)
  - [ ] 우선순위 레벨 설정 (높음, 보통, 낮음)
  - [ ] 알림 그룹핑 및 필터링
  - [ ] 스마트 알림 정렬
- [ ] 성능 최적화 구현 (AC: 5)
  - [ ] 알림 배치 처리 시스템
  - [ ] 인덱스 최적화 및 쿼리 튜닝
  - [ ] 캐싱 전략 구현
  - [ ] 백그라운드 처리 최적화
- [ ] 알림 설정 개인화 구현 (AC: 6)
  - [ ] 개인별 알림 시간 설정 (기본 10분)
  - [ ] 알림 유형별 활성화/비활성화
  - [ ] 알림 채널 설정 (인앱, 이메일 옵션)
  - [ ] 알림 음소거 및 방해 금지 모드
- [ ] 알림 히스토리 및 통계 구현 (AC: 7)
  - [ ] 알림 읽음/클릭 통계
  - [ ] 알림 효과성 분석
  - [ ] 사용자 행동 패턴 분석
  - [ ] 알림 설정 최적화 제안
- [ ] 테스트 구현 (AC: 8)
  - [ ] 단위 테스트 작성 (알림 서비스, 스케줄링)
  - [ ] 통합 테스트 작성 (알림 API, 워커 시스템)
  - [ ] 성능 테스트 작성 (대량 알림 처리)
  - [ ] 사용자 경험 테스트 작성

## Dev Notes

### Previous Story Insights
Story 1.3의 스케줄 CRUD 시스템과 Story 1.5의 반복 일정 시스템을 활용하여 일정 기반 알림을 생성합니다. Story 1.2의 인증 시스템을 통해 사용자별 알림 설정을 관리하고, Story 1.6의 권한 시스템을 통해 프로젝트별 알림 접근을 제어합니다.

### Data Models
- **알림 테이블**: `notifications(id, tenant_id, user_id, project_id, event_id, type, title, message, priority, status, read_at, created_at, scheduled_for, expires_at)` [Source: architecture.md#3.1]
- **알림 설정 테이블**: `notification_settings(id, tenant_id, user_id, event_reminder_minutes, enabled_types, quiet_hours_start, quiet_hours_end, created_at, updated_at)` [Source: architecture.md#3.1]
- **인덱스**: `(tenant_id, user_id, status, scheduled_for)`, `(tenant_id, user_id, created_at)` [Source: architecture.md#3.2]

### API Specifications
- **알림 목록 조회**: `GET /v1/notifications?status&type&priority&page&limit` [Source: architecture.md#5]
- **알림 상태 변경**: `PATCH /v1/notifications/:id` (읽음/삭제 상태 변경)
- **알림 설정 조회/수정**: `GET /v1/notification-settings`, `PATCH /v1/notification-settings`
- **알림 통계**: `GET /v1/notifications/stats` (읽음/클릭 통계)

#### API 요청/응답 예시
**알림 목록 조회**
```json
GET /v1/notifications?status=unread&priority=high&page=1&limit=20

Response: 200 OK
{
  "notifications": [
    {
      "id": "notif_123",
      "type": "event_reminder",
      "title": "팀 미팅 시작 10분 전",
      "message": "오늘 오후 2시 팀 미팅이 시작됩니다.",
      "priority": "high",
      "status": "unread",
      "project": {
        "id": "proj_123",
        "name": "웹사이트 리뉴얼",
        "color": "#FF6B6B"
      },
      "event": {
        "id": "event_456",
        "title": "팀 미팅",
        "starts_at": "2025-08-14T14:00:00+09:00"
      },
      "scheduled_for": "2025-08-14T13:50:00+09:00",
      "created_at": "2025-08-14T13:50:00+09:00"
    }
  ],
  "meta": {
    "total": 1,
    "unread_count": 1,
    "page": 1,
    "limit": 20
  }
}
```

**알림 설정 수정**
```json
PATCH /v1/notification-settings
{
  "event_reminder_minutes": 15,
  "enabled_types": ["event_reminder", "system"],
  "quiet_hours_start": "22:00",
  "quiet_hours_end": "08:00"
}

Response: 200 OK
{
  "id": "settings_789",
  "user_id": "user_123",
  "event_reminder_minutes": 15,
  "enabled_types": ["event_reminder", "system"],
  "quiet_hours_start": "22:00",
  "quiet_hours_end": "08:00",
  "updated_at": "2025-08-14T11:00:00Z"
}
```

**알림 상태 변경**
```json
PATCH /v1/notifications/notif_123
{
  "status": "read"
}

Response: 200 OK
{
  "id": "notif_123",
  "status": "read",
  "read_at": "2025-08-14T11:05:00Z",
  "updated_at": "2025-08-14T11:05:00Z"
}
```

### Component Specifications
- **알림 유형**: 일정 알림, 시스템 알림, 보안 알림 [Source: prd/04-scope.md]
- **알림 우선순위**: 높음, 보통, 낮음 (3단계)
- **알림 상태**: 예약됨, 전송됨, 읽음, 삭제됨
- **알림 시간**: 기본 10분, 사용자 설정 가능 (1분~60분)

### File Locations
- **API 라우터**: `src/api/v1/notifications.js`, `src/api/v1/notification-settings.js`
- **서비스 레이어**: `src/services/notificationService.js`, `src/services/notificationSettingService.js`
- **워커 시스템**: `src/workers/notificationWorker.js`, `src/queue/notificationQueue.js`
- **알림 엔진**: `src/engines/notificationEngine.js`, `src/engines/schedulingEngine.js`
- **프론트엔드**: `src/components/notifications/NotificationCenter.js`, `src/components/notifications/NotificationItem.js`
- **마이그레이션**: `src/database/migrations/006_create_notification_system.js`
- **테스트**: `tests/unit/notifications/`, `tests/integration/notifications/`

### Testing Requirements
- **테스트 프레임워크**: 단위 테스트 및 통합 테스트 [Source: architecture.md#9]
- **테스트 위치**: `tests/unit/notifications/`, `tests/integration/notifications/`
- **테스트 범위**: 알림 서비스, 스케줄링 엔진, 워커 시스템, 프론트엔드 컴포넌트
- **특별 고려사항**: 대량 알림 처리 테스트, 시간 기반 스케줄링 테스트, 사용자 경험 테스트

### Technical Constraints
- **데이터베이스**: PostgreSQL 사용 [Source: architecture.md#2]
- **워커 시스템**: BullMQ 사용, Redis 기반 [Source: architecture.md#4]
- **성능**: 알림 생성 p95 < 100ms [Source: architecture.md#8]
- **멀티테넌시**: 모든 테이블에 `tenant_id` 포함 [Source: architecture.md#3.1]

#### 성능 및 사용자 경험 요구사항
- **알림 생성 성능**: p95 < 100ms [Source: architecture.md#8]
- **알림 표시 지연**: 사용자 액션 후 < 50ms
- **배치 처리**: 대량 알림 시 진행률 표시
- **방해 금지**: quiet hours 설정 시 알림 자동 지연
- **개인화**: 사용자별 알림 설정 및 선호도 학습

### Project Structure Notes
인앱 알림 시스템은 Story 1.3의 스케줄 CRUD 시스템과 Story 1.5의 반복 일정 시스템을 기반으로 합니다. 일정 데이터를 모니터링하여 알림을 생성하고, 사용자별 설정에 따라 개인화된 알림을 제공합니다.

#### 알림 시스템 처리 플로우
```
일정 모니터링 → 알림 스케줄링 → 워커 처리 → 알림 생성 → 사용자별 전송 → 상태 관리 → 통계 수집
```

#### 엣지 케이스 및 예외 처리
- **알림 중복**: 같은 일정에 대한 중복 알림 방지
- **시간대 처리**: 사용자 로컬 시간대 기준 알림 전송
- **알림 폭주**: 대량 알림 시 배치 처리 및 우선순위 조정
- **방해 금지**: quiet hours 설정 시 알림 자동 지연
- **알림 만료**: 만료된 알림 자동 정리
- **사용자 비활성**: 장기간 비활성 사용자 알림 제한
- **성능 저하**: 알림 처리 지연 시 폴백 및 재시도
- **메모리 부족**: 대량 알림 시 메모리 사용량 모니터링

## Testing
- **테스트 파일 위치**: `tests/unit/notifications/`, `tests/integration/notifications/`
- **테스트 표준**: 단위 테스트, 통합 테스트, 성능 테스트, 사용자 경험 테스트 구현
- **테스트 프레임워크**: Jest 사용
- **특정 테스트 요구사항**: 알림 스케줄링 테스트, 대량 처리 테스트, 시간 기반 테스트, 사용자 설정 테스트

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-14 | 1.0 | 초기 스토리 생성 | Scrum Master |

## Dev Agent Record
*이 섹션은 개발 에이전트가 구현 중에 작성합니다.*

### Agent Model Used
*구현 시 사용된 AI 에이전트 모델과 버전을 기록합니다.*

### Debug Log References
*개발 중 생성된 디버그 로그나 추적을 기록합니다.*

### Completion Notes List
*작업 완료 및 발생한 이슈에 대한 노트를 기록합니다.*

### File List
*스토리 구현 중 생성, 수정 또는 영향받은 모든 파일을 나열합니다.*

## QA Results
*QA 에이전트의 완성된 스토리 구현 검토 결과입니다.*
