# Story 1.2: 계정/인증 시스템

## Status
Draft

## Story
**As a** 사용자,
**I want** 안전하게 계정을 생성하고 로그인할 수 있고,
**so that** 프로젝트와 캘린더에 접근할 수 있다.

## Acceptance Criteria
1. 사용자 등록 API 구현 (이메일/비밀번호 기반)
2. 사용자 로그인 API 구현 (JWT 토큰 발급)
3. 비밀번호 해싱 및 보안 구현 (Argon2/BCrypt)
4. JWT 토큰 검증 및 갱신 API 구현
5. 사용자 프로필 조회/수정 API 구현
6. 로그아웃 및 토큰 무효화 구현
7. 입력 검증 및 보안 검증 구현
8. 단위 테스트 및 통합 테스트 구현

## Tasks / Subtasks
- [ ] 사용자 데이터 모델 및 테이블 생성 (AC: 1, 2, 5)
  - [ ] 사용자 테이블 스키마 생성 (`users` 테이블)
  - [ ] 사용자 세션/토큰 테이블 스키마 생성 (`user_sessions` 테이블)
  - [ ] 마이그레이션 스크립트 작성
- [ ] 사용자 등록 API 구현 (AC: 1)
  - [ ] 사용자 등록 API (`POST /v1/auth/register`)
  - [ ] 이메일 중복 검증
  - [ ] 비밀번호 강도 검증
- [ ] 사용자 로그인 API 구현 (AC: 2)
  - [ ] 사용자 로그인 API (`POST /v1/auth/login`)
  - [ ] 비밀번호 검증
  - [ ] JWT 토큰 생성 및 응답
- [ ] 비밀번호 보안 구현 (AC: 3)
  - [ ] Argon2/BCrypt 해싱 구현
  - [ ] 비밀번호 정책 설정
  - [ ] 솔트 및 해시 저장
- [ ] JWT 토큰 관리 구현 (AC: 4)
  - [ ] JWT 토큰 검증 미들웨어
  - [ ] 토큰 갱신 API (`POST /v1/auth/refresh`)
  - [ ] 토큰 만료 처리
- [ ] 사용자 프로필 API 구현 (AC: 5)
  - [ ] 프로필 조회 API (`GET /v1/users/profile`)
  - [ ] 프로필 수정 API (`PATCH /v1/users/profile`)
  - [ ] 비밀번호 변경 API (`PATCH /v1/users/password`)
- [ ] 로그아웃 및 보안 구현 (AC: 6)
  - [ ] 로그아웃 API (`POST /v1/auth/logout`)
  - [ ] 토큰 블랙리스트 구현
  - [ ] 세션 무효화
- [ ] 입력 검증 및 보안 구현 (AC: 7)
  - [ ] zod/valibot 스키마 검증
  - [ ] XSS/SQLi 방지
  - [ ] 레이트 리미팅 구현
- [ ] 테스트 구현 (AC: 8)
  - [ ] 단위 테스트 작성 (인증 서비스, JWT 유틸리티)
  - [ ] 통합 테스트 작성 (인증 API 엔드포인트)
  - [ ] 보안 테스트 작성 (비밀번호 해싱, 토큰 검증)

## Dev Notes

### Previous Story Insights
Story 1.1에서 구현된 테넌트/프로젝트/멤버 시스템과 연동되어야 합니다. 사용자 인증 후 해당 사용자의 프로젝트 멤버십을 확인할 수 있어야 합니다.

### Data Models
- **사용자 테이블**: `users(id, tenant_id, email, password_hash, first_name, last_name, created_at, updated_at)` [Source: architecture.md#3.1 - 테넌시 포함 원칙]
- **사용자 세션 테이블**: `user_sessions(id, user_id, token_hash, expires_at, created_at)` [Source: architecture.md#10 - 보안 원칙]

### API Specifications
- **인증 API**: `POST /v1/auth/register`, `POST /v1/auth/login`, `POST /v1/auth/logout`, `POST /v1/auth/refresh` [Source: architecture.md#5 - API 버전 규칙]
- **사용자 API**: `GET /v1/users/profile`, `PATCH /v1/users/profile`, `PATCH /v1/users/password` [Source: architecture.md#5 - API 패턴]
- **오류코드**: 400/401/403/404/409/410/422/429/500 사용 [Source: architecture.md#5]
- **레이트 리미팅**: 로그인 5 rpm/IP, 등록 3 rpm/IP [Source: architecture.md#5 - 보안 원칙]

#### API 요청/응답 예시
**사용자 등록**
```json
POST /v1/auth/register
{
  "email": "user@example.com",
  "password": "SecurePass123!",
  "first_name": "홍",
  "last_name": "길동"
}

Response: 201 Created
{
  "id": "user_123",
  "email": "user@example.com",
  "first_name": "홍",
  "last_name": "길동",
  "tenant_id": "tenant_001",
  "created_at": "2025-08-14T10:00:00Z"
}
```

**사용자 로그인**
```json
POST /v1/auth/login
{
  "email": "user@example.com",
  "password": "SecurePass123!"
}

Response: 200 OK
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expires_in": 3600,
  "token_type": "Bearer"
}
```

### Component Specifications
- **JWT 토큰**: 만료 시간 설정, 갱신 메커니즘 [Source: architecture.md#10]
- **비밀번호 해싱**: Argon2/BCrypt 사용 [Source: architecture.md#10]
- **보안 미들웨어**: 토큰 검증, 권한 확인 [Source: architecture.md#6 - ACL 미들웨어]

### File Locations
- **API 라우터**: `src/api/v1/auth.js`, `src/api/v1/users.js`
- **서비스 레이어**: `src/services/authService.js`, `src/services/userService.js`
- **데이터 모델**: `src/models/user.js`, `src/models/userSession.js`
- **미들웨어**: `src/middleware/auth.js`, `src/middleware/rateLimit.js`
- **유틸리티**: `src/utils/jwt.js`, `src/utils/password.js`
- **마이그레이션**: `src/database/migrations/002_create_user_tables.js`
- **테스트**: `tests/unit/auth/`, `tests/integration/auth/`

### Testing Requirements
- **테스트 프레임워크**: 단위 테스트 및 통합 테스트 [Source: architecture.md#9]
- **테스트 위치**: `tests/unit/auth/`, `tests/integration/auth/`
- **테스트 범위**: 인증 서비스, JWT 유틸리티, API 엔드포인트, 보안 검증
- **특별 고려사항**: 비밀번호 해싱 테스트, 토큰 만료 테스트, 레이트 리미팅 테스트

### Technical Constraints
- **데이터베이스**: PostgreSQL 사용 [Source: architecture.md#2]
- **API 프레임워크**: Fastify 사용 [Source: architecture.md#1]
- **입력 검증**: zod/valibot 스키마 사용 [Source: architecture.md#6]
- **보안**: HTTPS/HSTS, CSP, XSS/SQLi 무해화 [Source: architecture.md#6]
- **멀티테넌시**: 사용자 테이블에 `tenant_id` 포함 [Source: architecture.md#3.1]

#### 보안 정책 세부사항
- **비밀번호 정책**: 최소 8자, 대문자/소문자/숫자/특수문자 포함
- **JWT 설정**: 액세스 토큰 1시간, 리프레시 토큰 7일
- **해싱 알고리즘**: Argon2id (메모리 64MB, 시간 3, 병렬도 1)
- **세션 관리**: 동시 로그인 제한 5개, 자동 만료 처리
- **감사 로그**: 로그인/로그아웃, 비밀번호 변경, 권한 변경 기록

### Project Structure Notes
인증 시스템은 Story 1.1의 프로젝트/멤버 시스템과 밀접하게 연동됩니다. 사용자 인증 후 해당 사용자의 프로젝트 멤버십을 확인하여 권한을 부여하는 흐름을 구현해야 합니다.

#### 인증 플로우 다이어그램
```
사용자 로그인 → JWT 토큰 발급 → API 요청 → 토큰 검증 → 사용자 정보 추출 → 프로젝트 멤버십 확인 → 권한 부여
```

#### 엣지 케이스 및 예외 처리
- **중복 이메일**: 이미 등록된 이메일로 가입 시도 시 409 Conflict 반환
- **잘못된 인증**: 잘못된 이메일/비밀번호 시 401 Unauthorized 반환
- **토큰 만료**: 만료된 토큰으로 API 호출 시 401 Unauthorized 반환
- **레이트 리미팅 초과**: 로그인 시도 초과 시 429 Too Many Requests 반환
- **계정 잠금**: 연속 로그인 실패 5회 시 계정 임시 잠금 (15분)
- **세션 충돌**: 동시 로그인 제한 초과 시 기존 세션 무효화

## Testing
- **테스트 파일 위치**: `tests/unit/auth/`, `tests/integration/auth/`
- **테스트 표준**: 단위 테스트, 통합 테스트, 보안 테스트 구현
- **테스트 프레임워크**: Jest 또는 Mocha 사용
- **특정 테스트 요구사항**: 비밀번호 해싱 검증, JWT 토큰 검증, 레이트 리미팅 테스트, 보안 취약점 테스트

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-14 | 1.0 | 초기 스토리 생성 | Scrum Master |

## Dev Agent Record
*이 섹션은 개발 에이전트가 구현 중에 작성합니다.*

### Agent Model Used
*구현 시 사용된 AI 에이전트 모델과 버전을 기록합니다.*

### Debug Log References
*개발 중 생성된 디버그 로그나 추적을 참조합니다.*

### Completion Notes List
*작업 완료 및 발생한 이슈에 대한 노트를 기록합니다.*

### File List
*스토리 구현 중 생성, 수정 또는 영향받은 모든 파일을 나열합니다.*

## QA Results
*QA 에이전트의 완성된 스토리 구현 검토 결과입니다.*
