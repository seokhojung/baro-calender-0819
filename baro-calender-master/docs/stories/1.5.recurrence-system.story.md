# Story 1.5: 반복 일정 시스템

## Status
Draft

## Story
**As a** 사용자,
**I want** 반복 일정을 생성하고 관리할 수 있고,
**so that** 정기적인 미팅이나 작업을 효율적으로 스케줄링할 수 있다.

## Acceptance Criteria
1. 기본 반복 규칙 구현 (매주, 격주, 요일 반복)
2. 반복 일정 생성 API 구현 (RRULE 기반)
3. 반복 일정 전개 엔진 구현 (Occurrence 생성)
4. 휴무(예외) 등록 및 관리 기능 구현
5. 반복 일정 수정/삭제 시 전개 데이터 동기화
6. 성능 최적화 (1k occurrence 당 ≤ 400ms)
7. 워커 시스템 구현 (BullMQ 기반)
8. 단위 테스트 및 통합 테스트 구현

## Tasks / Subtasks
- [ ] 반복 규칙 데이터 모델 확장 (AC: 1, 2)
  - [ ] `events.rrule_json` 필드 활용 (RFC 5545 RRULE)
  - [ ] `event_occurrences` 테이블 스키마 확인
  - [ ] 반복 규칙 파싱 및 검증 로직 구현
- [ ] 기본 반복 규칙 UI 구현 (AC: 1)
  - [ ] 반복 유형 선택 (매주/격주/요일)
  - [ ] 반복 주기 설정 (1주, 2주, 3주 등)
  - [ ] 반복 종료 조건 설정 (횟수/날짜)
  - [ ] 요일 선택 UI (월요일~일요일)
- [ ] 반복 일정 생성 API 구현 (AC: 2)
  - [ ] 반복 일정 생성 API (`POST /v1/events` with rrule)
  - [ ] RRULE 파라미터 검증 및 변환
  - [ ] 반복 규칙 JSON 저장
  - [ ] 초기 occurrence 생성
- [ ] 반복 일정 전개 엔진 구현 (AC: 3)
  - [ ] RRULE 파싱 및 계산 엔진
  - [ ] ±90일 윈도우 기반 occurrence 생성
  - [ ] 시간대 변환 처리 (UTC ↔ 로컬)
  - [ ] 전개 성능 최적화
- [ ] 휴무(예외) 관리 구현 (AC: 4)
  - [ ] 예외 날짜 등록 (`exdates_json`)
  - [ ] 예외 일정 수정/삭제
  - [ ] 예외 적용 로직 구현
- [ ] 반복 일정 수정/삭제 동기화 (AC: 5)
  - [ ] 반복 규칙 변경 시 occurrence 재생성
  - [ ] 개별 occurrence 수정/삭제
  - [ ] 데이터 무결성 보장 (soft delete + re-gen)
- [ ] 성능 최적화 구현 (AC: 6)
  - [ ] 인덱스 최적화 (`GIST tsrange`)
  - [ ] 캐싱 전략 구현
  - [ ] 배치 처리 및 지연 로딩
- [ ] 워커 시스템 구현 (AC: 7)
  - [ ] BullMQ 기반 작업 큐 설정
  - [ ] 동시성 제어 (4개 워커)
  - [ ] 재시도/백오프 로직 (최대 5회, 지수)
  - [ ] 모니터링 및 알람 설정
- [ ] 테스트 구현 (AC: 8)
  - [ ] 단위 테스트 작성 (반복 규칙, 전개 엔진)
  - [ ] 통합 테스트 작성 (API 엔드포인트)
  - [ ] 성능 테스트 작성 (1k occurrence ≤ 400ms)
  - [ ] 워커 시스템 테스트

## Dev Notes

### Previous Story Insights
Story 1.3의 스케줄 CRUD 시스템을 확장하여 반복 기능을 추가합니다. 기존 일정 생성/수정/삭제 API에 반복 규칙을 추가하고, 새로운 occurrence 전개 엔진을 구현합니다.

### Data Models
- **일정 테이블**: `events(id, tenant_id, project_id, title, starts_at_utc, ends_at_utc, timezone, is_all_day, rrule_json, exdates_json, created_by, created_at, updated_at)` [Source: architecture.md#3.1]
- **일정 발생 테이블**: `event_occurrences(id, tenant_id, event_id, start_utc, end_utc, window_from_utc, window_to_utc, generated_at)` [Source: architecture.md#3.1]
- **인덱스**: `(tenant_id, project_id, start_utc)`, `GIST tsrange(start_utc, end_utc)` [Source: architecture.md#3.2]

### API Specifications
- **반복 일정 생성**: `POST /v1/events` with rrule 파라미터 [Source: architecture.md#5]
- **반복 일정 수정**: `PATCH /v1/events/:id` with rrule 업데이트
- **반복 일정 삭제**: `DELETE /v1/events/:id` (soft delete + occurrence 정리)
- **일정 발생 조회**: `GET /v1/timeline` (기존 API 활용)

#### API 요청/응답 예시
**반복 일정 생성**
```json
POST /v1/events
{
  "title": "주간 팀 미팅",
  "project_id": "proj_123",
  "starts_at": "2025-08-15T09:00:00+09:00",
  "ends_at": "2025-08-15T10:00:00+09:00",
  "timezone": "Asia/Seoul",
  "is_all_day": false,
  "rrule": {
    "freq": "WEEKLY",
    "interval": 1,
    "byweekday": ["MO"],
    "until": "2025-12-31T23:59:59Z"
  },
  "tags": ["미팅", "팀워크"]
}

Response: 201 Created
{
  "id": "event_456",
  "title": "주간 팀 미팅",
  "project_id": "proj_123",
  "starts_at_utc": "2025-08-15T00:00:00Z",
  "ends_at_utc": "2025-08-15T01:00:00Z",
  "timezone": "Asia/Seoul",
  "rrule_json": {
    "freq": "WEEKLY",
    "interval": 1,
    "byweekday": ["MO"],
    "until": "2025-12-31T23:59:59Z"
  },
  "occurrences_generated": 20,
  "created_at": "2025-08-14T10:00:00Z"
}
```

**예외 날짜 등록**
```json
PATCH /v1/events/456
{
  "exdates": ["2025-09-01T00:00:00Z", "2025-10-06T00:00:00Z"]
}

Response: 200 OK
{
  "id": "event_456",
  "exdates_json": ["2025-09-01T00:00:00Z", "2025-10-06T00:00:00Z"],
  "occurrences_updated": true,
  "updated_at": "2025-08-14T11:00:00Z"
}
```

### Component Specifications
- **반복 규칙**: RFC 5545 RRULE 표준 준수 [Source: prd/05-time-timezone-format-rules.md]
- **전개 엔진**: ±90일 윈도우 기반 materialize 방식 [Source: architecture.md#4]
- **워커 시스템**: BullMQ 기반, 4개 동시성 [Source: architecture.md#4]
- **성능 목표**: 1k occurrence 당 ≤ 400ms [Source: architecture.md#4]

### File Locations
- **API 라우터**: `src/api/v1/events.js` (기존 확장)
- **서비스 레이어**: `src/services/recurrenceService.js`, `src/services/occurrenceService.js`
- **전개 엔진**: `src/engines/rruleEngine.js`, `src/engines/occurrenceEngine.js`
- **워커 시스템**: `src/workers/recurrenceWorker.js`, `src/queue/bullmq.js`
- **유틸리티**: `src/utils/rrule.js`, `src/utils/dateCalculations.js`
- **마이그레이션**: `src/database/migrations/004_add_recurrence_support.js`
- **테스트**: `tests/unit/recurrence/`, `tests/integration/recurrence/`

### Testing Requirements
- **테스트 프레임워크**: 단위 테스트 및 통합 테스트 [Source: architecture.md#9]
- **테스트 위치**: `tests/unit/recurrence/`, `tests/integration/recurrence/`
- **테스트 범위**: 반복 규칙 파싱, 전개 엔진, 워커 시스템, 성능 측정
- **특별 고려사항**: RRULE 검증 테스트, occurrence 생성 테스트, 성능 SLO 테스트

### Technical Constraints
- **데이터베이스**: PostgreSQL 사용 [Source: architecture.md#2]
- **반복 규칙**: RFC 5545 RRULE 표준 준수 [Source: prd/05-time-timezone-format-rules.md]
- **시간 처리**: UTC 저장, ISO-8601 포맷 [Source: prd/05-time-timezone-format-rules.md]
- **워커 시스템**: BullMQ 사용, Redis 기반 [Source: architecture.md#4]
- **멀티테넌시**: 모든 테이블에 `tenant_id` 포함 [Source: architecture.md#3.1]

#### 성능 및 운영 요구사항
- **전개 성능**: 1k occurrence 당 ≤ 400ms [Source: architecture.md#4]
- **조회 윈도우**: 기본 ±90일 [Source: architecture.md#4]
- **워커 동시성**: 4개 (초기) [Source: architecture.md#4]
- **재시도/백오프**: 최대 5회, 지수(1s→2s→4s→…) [Source: architecture.md#4]
- **데이터 무결성**: soft delete 후 재생성(re-gen) [Source: architecture.md#4]

### Project Structure Notes
반복 일정 시스템은 Story 1.3의 스케줄 CRUD 시스템을 확장합니다. 기존 일정 API에 반복 규칙을 추가하고, 새로운 occurrence 전개 엔진과 워커 시스템을 구현합니다.

#### 반복 일정 처리 플로우
```
사용자 반복 규칙 설정 → RRULE 파싱 → occurrence 전개 → 워커 처리 → 데이터베이스 저장 → 캐시 업데이트
```

#### 엣지 케이스 및 예외 처리
- **잘못된 RRULE**: 유효하지 않은 반복 규칙 시 422 Unprocessable Entity 반환
- **전개 실패**: occurrence 생성 실패 시 워커 재시도 및 사용자 알림
- **성능 저하**: 대량 occurrence 생성 시 배치 처리 및 진행률 표시
- **시간대 변경**: DST 전환 시 occurrence 재계산 및 동기화
- **예외 날짜 충돌**: 예외 날짜가 반복 규칙과 충돌 시 사용자 확인
- **워커 장애**: 워커 실패 시 자동 재시작 및 장애 알림
- **메모리 부족**: 대량 전개 시 메모리 사용량 모니터링 및 제한

## Testing
- **테스트 파일 위치**: `tests/unit/recurrence/`, `tests/integration/recurrence/`
- **테스트 표준**: 단위 테스트, 통합 테스트, 성능 테스트, 워커 테스트 구현
- **테스트 프레임워크**: Jest 사용
- **특정 테스트 요구사항**: RRULE 검증 테스트, occurrence 생성 테스트, 성능 SLO 테스트, 워커 시스템 테스트

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-14 | 1.0 | 초기 스토리 생성 | Scrum Master |

## Dev Agent Record
*이 섹션은 개발 에이전트가 구현 중에 작성합니다.*

### Agent Model Used
*구현 시 사용된 AI 에이전트 모델과 버전을 기록합니다.*

### Debug Log References
*개발 중 생성된 디버그 로그나 추적을 기록합니다.*

### Completion Notes List
*작업 완료 및 발생한 이슈에 대한 노트를 기록합니다.*

### File List
*스토리 구현 중 생성, 수정 또는 영향받은 모든 파일을 나열합니다.*

## QA Results
*QA 에이전트의 완성된 스토리 구현 검토 결과입니다.*
