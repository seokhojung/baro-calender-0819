# Story 1.3: 스케줄 CRUD 시스템

## Status
Draft

## Story
**As a** 사용자,
**I want** 프로젝트 내에서 일정을 생성, 수정, 삭제할 수 있고,
**so that** 캘린더에 일정을 관리하고 팀원들과 공유할 수 있다.

## Acceptance Criteria
1. 일정 생성 API 구현 (제목, 시작/종료 시간, 프로젝트, 태그)
2. 일정 수정 API 구현 (기존 일정 정보 업데이트)
3. 일정 삭제 API 구현 (소프트 삭제 및 하드 삭제)
4. 일정 조회 API 구현 (타임라인 기반, 필터링 지원)
5. 시간/타임존 처리 구현 (UTC 저장, 로컬 표시)
6. 태그 시스템 구현 (정규화된 태그 테이블)
7. 권한 기반 일정 접근 제어 구현
8. 단위 테스트 및 통합 테스트 구현

## Tasks / Subtasks
- [ ] 일정 데이터 모델 및 테이블 생성 (AC: 1, 2, 3, 5, 6)
  - [ ] 일정 테이블 스키마 생성 (`events` 테이블)
  - [ ] 일정 태그 테이블 스키마 생성 (`event_tags` 테이블)
  - [ ] 마이그레이션 스크립트 작성
- [ ] 일정 생성 API 구현 (AC: 1)
  - [ ] 일정 생성 API (`POST /v1/events`)
  - [ ] 입력 데이터 검증 (제목, 시간, 프로젝트 ID)
  - [ ] 태그 처리 및 정규화
  - [ ] 멱등성 키 지원 (Idempotency-Key)
- [ ] 일정 수정 API 구현 (AC: 2)
  - [ ] 일정 수정 API (`PATCH /v1/events/:id`)
  - [ ] 부분 업데이트 지원
  - [ ] 권한 검증 (편집 권한 확인)
- [ ] 일정 삭제 API 구현 (AC: 3)
  - [ ] 일정 삭제 API (`DELETE /v1/events/:id`)
  - [ ] 소프트 삭제 구현
  - [ ] 연관 데이터 정리 (태그, 댓글)
- [ ] 일정 조회 API 구현 (AC: 4)
  - [ ] 타임라인 조회 API (`GET /v1/timeline`)
  - [ ] 기간 기반 필터링 (from, to)
  - [ ] 프로젝트별 필터링
  - [ ] 태그별 필터링
  - [ ] 담당자별 필터링
- [ ] 시간/타임존 처리 구현 (AC: 5)
  - [ ] UTC 저장 및 로컬 표시 변환
  - [ ] ISO-8601 포맷 지원
  - [ ] 자정 넘김(overnight) 처리
  - [ ] 종일 일정 처리
- [ ] 태그 시스템 구현 (AC: 6)
  - [ ] 태그 정규화 및 저장
  - [ ] 태그 검색 및 자동완성
  - [ ] 태그별 일정 필터링
- [ ] 권한 제어 구현 (AC: 7)
  - [ ] 프로젝트 멤버십 기반 권한 확인
  - [ ] Owner/Editor만 편집 가능
  - [ ] Viewer는 읽기만 가능
- [ ] 테스트 구현 (AC: 8)
  - [ ] 단위 테스트 작성 (일정 서비스, 태그 서비스)
  - [ ] 통합 테스트 작성 (일정 API 엔드포인트)
  - [ ] 시간/타임존 처리 테스트
  - [ ] 권한 제어 테스트

## Dev Notes

### Previous Story Insights
Story 1.1과 1.2에서 구현된 프로젝트/멤버 시스템과 인증 시스템을 활용합니다. 사용자 인증 후 프로젝트 멤버십을 확인하여 일정 접근 권한을 부여합니다.

### Data Models
- **일정 테이블**: `events(id, tenant_id, project_id, title, starts_at_utc, ends_at_utc, timezone, is_all_day, rrule_json, exdates_json, created_by, created_at, updated_at)` [Source: architecture.md#3.1]
- **일정 태그 테이블**: `event_tags(event_id, tag)` [Source: architecture.md#3.1]
- **인덱스**: `(tenant_id, project_id, starts_at_utc)`, `(tenant_id, project_id, ends_at_utc)` [Source: architecture.md#3.2]

### API Specifications
- **일정 CRUD**: `POST /v1/events`, `PATCH /v1/events/:id`, `DELETE /v1/events/:id` [Source: architecture.md#5]
- **타임라인 조회**: `GET /v1/timeline?from&to&projects[]=…&assignees[]=…&tags=…` [Source: architecture.md#5]
- **API 버전**: 모든 엔드포인트는 `/v1` 경로 사용 [Source: architecture.md#5]
- **오류코드**: 400/401/403/404/409/410/422/429/500 사용 [Source: architecture.md#5]
- **멱등성**: `POST`에 **Idempotency-Key** 헤더(24h) 지원 [Source: architecture.md#5]

#### API 요청/응답 예시
**일정 생성**
```json
POST /v1/events
{
  "title": "팀 미팅",
  "project_id": "proj_123",
  "starts_at": "2025-08-15T09:00:00+09:00",
  "ends_at": "2025-08-15T10:00:00+09:00",
  "timezone": "Asia/Seoul",
  "is_all_day": false,
  "tags": ["미팅", "팀워크"],
  "description": "주간 팀 미팅"
}

Response: 201 Created
{
  "id": "event_456",
  "title": "팀 미팅",
  "project_id": "proj_123",
  "starts_at_utc": "2025-08-15T00:00:00Z",
  "ends_at_utc": "2025-08-15T01:00:00Z",
  "timezone": "Asia/Seoul",
  "is_all_day": false,
  "tags": ["미팅", "팀워크"],
  "created_by": "user_789",
  "created_at": "2025-08-14T10:00:00Z"
}
```

**타임라인 조회**
```json
GET /v1/timeline?from=2025-08-15T00:00:00Z&to=2025-08-21T23:59:59Z&projects[]=proj_123&tags=미팅

Response: 200 OK
{
  "events": [
    {
      "id": "event_456",
      "title": "팀 미팅",
      "project_id": "proj_123",
      "starts_at": "2025-08-15T09:00:00+09:00",
      "ends_at": "2025-08-15T10:00:00+09:00",
      "timezone": "Asia/Seoul",
      "is_all_day": false,
      "tags": ["미팅", "팀워크"]
    }
  ],
  "meta": {
    "total": 1,
    "from": "2025-08-15T00:00:00Z",
    "to": "2025-08-21T23:59:59Z"
  }
}
```

### Component Specifications
- **시간 처리**: UTC 저장, 로컬 표시, ISO-8601 포맷 [Source: prd/05-time-timezone-format-rules.md]
- **권한 모델**: 프로젝트 멤버십 기반 접근 제어 [Source: prd/06-permissions-acl.md]
- **태그 시스템**: 정규화된 태그 테이블, 검색 및 필터링 [Source: architecture.md#3.1]

### File Locations
- **API 라우터**: `src/api/v1/events.js`, `src/api/v1/timeline.js`
- **서비스 레이어**: `src/services/eventService.js`, `src/services/tagService.js`
- **데이터 모델**: `src/models/event.js`, `src/models/eventTag.js`
- **유틸리티**: `src/utils/timezone.js`, `src/utils/dateTime.js`
- **마이그레이션**: `src/database/migrations/003_create_event_tables.js`
- **테스트**: `tests/unit/events/`, `tests/integration/events/`

### Testing Requirements
- **테스트 프레임워크**: 단위 테스트 및 통합 테스트 [Source: architecture.md#9]
- **테스트 위치**: `tests/unit/events/`, `tests/integration/events/`
- **테스트 범위**: 일정 서비스, 태그 서비스, API 엔드포인트, 시간/타임존 처리
- **특별 고려사항**: 시간대 변환 테스트, 태그 정규화 테스트, 권한 제어 테스트

### Technical Constraints
- **데이터베이스**: PostgreSQL 사용 [Source: architecture.md#2]
- **API 프레임워크**: Fastify 사용 [Source: architecture.md#1]
- **입력 검증**: zod/valibot 스키마 사용 [Source: architecture.md#6]
- **시간 처리**: UTC 저장, ISO-8601 포맷, RFC 5545 준거 [Source: prd/05-time-timezone-format-rules.md]
- **멀티테넌시**: 모든 테이블에 `tenant_id` 포함 [Source: architecture.md#3.1]

#### 성능 및 보안 요구사항
- **데이터베이스 성능**: 타임라인 조회 API p95 < 300ms [Source: architecture.md#8]
- **캐시**: GET 요청 60초 캐시, ETag 지원 [Source: architecture.md#5]
- **보안**: 프로젝트 멤버십 기반 권한 검증
- **입력 제한**: 제목 최대 200자, 설명 최대 1000자
- **레이트 리미팅**: 쓰기 30 rpm/유저 [Source: architecture.md#5]

### Project Structure Notes
일정 시스템은 Story 1.1의 프로젝트/멤버 시스템과 Story 1.2의 인증 시스템을 기반으로 합니다. 사용자 인증 후 프로젝트 멤버십을 확인하여 일정 접근 권한을 부여하는 흐름을 구현해야 합니다.

#### 일정 처리 플로우
```
사용자 요청 → 인증 확인 → 프로젝트 멤버십 확인 → 권한 검증 → 일정 CRUD 처리 → 응답 반환
```

#### 엣지 케이스 및 예외 처리
- **권한 부족**: 편집 권한이 없는 사용자의 일정 수정 시 403 Forbidden 반환
- **존재하지 않는 일정**: 존재하지 않는 일정 접근 시 404 Not Found 반환
- **시간 충돌**: 시작 시간이 종료 시간보다 늦을 때 422 Unprocessable Entity 반환
- **프로젝트 없음**: 존재하지 않는 프로젝트에 일정 생성 시 404 Not Found 반환
- **태그 제한**: 너무 많은 태그(최대 10개) 추가 시 422 Unprocessable Entity 반환
- **자정 넘김**: 자정을 넘기는 일정은 겹침 규칙 적용하여 표시

## Testing
- **테스트 파일 위치**: `tests/unit/events/`, `tests/integration/events/`
- **테스트 표준**: 단위 테스트, 통합 테스트, 시간 처리 테스트 구현
- **테스트 프레임워크**: Jest 또는 Mocha 사용
- **특정 테스트 요구사항**: 시간대 변환 테스트, 태그 정규화 테스트, 권한 제어 테스트, 멱등성 테스트

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-14 | 1.0 | 초기 스토리 생성 | Scrum Master |

## Dev Agent Record
*이 섹션은 개발 에이전트가 구현 중에 작성합니다.*

### Agent Model Used
*구현 시 사용된 AI 에이전트 모델과 버전을 기록합니다.*

### Debug Log References
*개발 중 생성된 디버그 로그나 추적을 기록합니다.*

### Completion Notes List
*작업 완료 및 발생한 이슈에 대한 노트를 기록합니다.*

### File List
*스토리 구현 중 생성, 수정 또는 영향받은 모든 파일을 나열합니다.*

## QA Results
*QA 에이전트의 완성된 스토리 구현 검토 결과입니다.*
